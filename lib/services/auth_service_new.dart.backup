import 'package:flutter/foundation.dart';
import 'package:shared_preferences/shared_preferences.dart';
import 'package:firebase_auth/firebase_auth.dart';
import 'firebase_auth_service.dart';
import 'firestore_user_service.dart';
import 'social_auth_service.dart';
import 'crashlytics_service.dart';
import '../models/firestore_user.dart';

/// æ•´åˆèªè­‰æœå‹™
/// çµåˆæœ¬åœ°å­˜å„²ã€Firebase Auth å’Œ Firestore çš„å®Œæ•´èªè­‰è§£æ±ºæ–¹æ¡ˆ
class AuthService extends ChangeNotifier {
  static const String _isFirstLaunchKey = 'is_first_launch';
  static const String _hasCompletedOnboardingKey = 'has_completed_onboarding';
  static const String _userRegisteredKey = 'user_registered';
  static const String _lastSyncTimeKey = 'last_sync_time';
  
  // æœå‹™ä¾è³´
  final FirebaseAuthService _firebaseAuthService = FirebaseAuthService();
  final FirestoreUserService _firestoreUserService = FirestoreUserService();
  final SocialAuthService _socialAuthService = SocialAuthService();
  
  // æœ¬åœ°ç‹€æ…‹
  bool _isInitialized = false;
  bool _isFirstLaunch = true;
  bool _hasCompletedOnboarding = false;
  bool _isUserRegistered = false;
  DateTime? _lastSyncTime;
  
  // ç”¨æˆ¶è³‡æ–™ï¼ˆä¾†è‡ª Firestoreï¼‰
  FirestoreUser? _currentUser;
  
  // Getters for local state
  bool get isInitialized => _isInitialized;
  bool get isFirstLaunch => _isFirstLaunch;
  bool get hasCompletedOnboarding => _hasCompletedOnboarding;
  bool get isUserRegistered => _isUserRegistered;
  DateTime? get lastSyncTime => _lastSyncTime;
  
  // Getters for user data (from Firestore)
  FirestoreUser? get currentUser => _currentUser;
  String? get userId => _currentUser?.uid;
  DateTime? get registrationDate => _currentUser?.registrationDate;
  String? get nickname => _currentUser?.nickname;
  String? get email => _currentUser?.email;
  String? get gender => _currentUser?.gender;
  DateTime? get birthDate => _currentUser?.birthDate;
  double? get height => _currentUser?.height;
  double? get weight => _currentUser?.weight;
  String? get profilePhotoUrl => _currentUser?.profilePhotoUrl;
  
  // Firebase æ•´åˆ getters
  FirebaseAuthService get firebaseAuthService => _firebaseAuthService;
  FirestoreUserService get firestoreUserService => _firestoreUserService;
  SocialAuthService get socialAuthService => _socialAuthService;
  bool get isFirebaseAuthenticated => _firebaseAuthService.isAuthenticated;
  String? get firebaseUserId => _firebaseAuthService.uid;
  User? get currentFirebaseUser => _firebaseAuthService.currentUser;
  
  /// åˆå§‹åŒ–èªè­‰æœå‹™
  Future<void> initialize() async {
    try {
      debugPrint('ğŸ”§ Initializing AuthService...');
      
      // 1. è¼‰å…¥æœ¬åœ°ç‹€æ…‹ï¼ˆå„ªå…ˆï¼Œé€™æ¨£è‡³å°‘åŸºæœ¬åŠŸèƒ½å¯ä»¥å·¥ä½œï¼‰
      await _loadLocalState();
      
      // 2. å˜—è©¦åˆå§‹åŒ– Firebase ç›¸é—œæœå‹™ï¼ˆå¦‚æœå¤±æ•—ä¸é˜»å¡ï¼‰
      try {
        await _firebaseAuthService.initialize();
        await _firestoreUserService.initialize();
        debugPrint('âœ… Firebase services initialized');
      } catch (e) {
        debugPrint('âš ï¸ Firebase initialization failed (will work offline): $e');
      }
      
      // 3. åˆå§‹åŒ– Social Auth Service  
      try {
        await _socialAuthService.initialize();
      } catch (e) {
        debugPrint('âš ï¸ Social Auth initialization failed: $e');
      }
      
      // 4. è¨­ç½®ç›£è½å™¨
      _setupListeners();
      
      // 5. å˜—è©¦åŒæ­¥ç”¨æˆ¶è³‡æ–™ï¼ˆå¦‚æœFirebaseå¯ç”¨ï¼‰
      try {
        await _syncUserData();
      } catch (e) {
        debugPrint('âš ï¸ User data sync failed: $e');
      }
      
      // 6. æ¨™è¨˜ç‚ºå·²åˆå§‹åŒ–
      _isInitialized = true;
      notifyListeners();
      
      debugPrint('âœ… AuthService initialized successfully');
    } catch (e, stack) {
      debugPrint('âŒ AuthService initialization failed: $e');
      _isInitialized = true; // å³ä½¿å¤±æ•—ä¹Ÿè¦æ¨™è¨˜ç‚ºåˆå§‹åŒ–å®Œæˆï¼Œé¿å…ç„¡é™è¼‰å…¥
      notifyListeners();
      await CrashlyticsService.recordError(e, stack, reason: 'AuthService initialization failed');
    }
  }
  
  /// è¨­ç½®ç›£è½å™¨
  void _setupListeners() {
    // ç›£è½ Firebase Auth ç‹€æ…‹è®ŠåŒ–
    _firebaseAuthService.addListener(_onFirebaseAuthChanged);
    
    // ç›£è½ Firestore ç”¨æˆ¶è³‡æ–™è®ŠåŒ–
    _firestoreUserService.addListener(_onFirestoreUserChanged);
    
    // ç›£è½ Social Auth è®ŠåŒ–
    _socialAuthService.addListener(_onSocialAuthChanged);
  }
  
  /// Firebase Auth ç‹€æ…‹è®ŠåŒ–è™•ç†
  Future<void> _onFirebaseAuthChanged() async {
    try {
      final firebaseUser = _firebaseAuthService.currentUser;
      
      if (firebaseUser != null) {
        debugPrint('ğŸ”¥ Firebase user signed in: ${firebaseUser.uid}');
        
        // æª¢æŸ¥æ˜¯å¦éœ€è¦å‰µå»º Firestore ç”¨æˆ¶è³‡æ–™
        final userExists = await _firestoreUserService.userExists(firebaseUser.uid);
        if (!userExists) {
          await _createFirestoreUser(firebaseUser);
        }
        
        // åŒæ­¥ç¤¾äº¤å¸³æˆ¶è³‡è¨Š
        await _syncSocialAccounts();
        
      } else {
        debugPrint('ğŸ”¥ Firebase user signed out');
        _currentUser = null;
      }
      
      notifyListeners();
    } catch (e, stack) {
      debugPrint('âŒ Error handling Firebase auth change: $e');
      await CrashlyticsService.recordError(e, stack, reason: 'Firebase auth change handling failed');
    }
  }
  
  /// Firestore ç”¨æˆ¶è³‡æ–™è®ŠåŒ–è™•ç†
  void _onFirestoreUserChanged() {
    _currentUser = _firestoreUserService.currentUser;
    
    if (_currentUser != null) {
      _isUserRegistered = true;
      _saveLocalState();
    }
    
    notifyListeners();
  }
  
  /// Social Auth è®ŠåŒ–è™•ç†
  Future<void> _onSocialAuthChanged() async {
    await _syncSocialAccounts();
  }
  
  /// è¼‰å…¥æœ¬åœ°ç‹€æ…‹
  Future<void> _loadLocalState() async {
    try {
      final prefs = await SharedPreferences.getInstance();
      
      _isFirstLaunch = prefs.getBool(_isFirstLaunchKey) ?? true;
      _hasCompletedOnboarding = prefs.getBool(_hasCompletedOnboardingKey) ?? false;
      _isUserRegistered = prefs.getBool(_userRegisteredKey) ?? false;
      
      final lastSyncTimeMs = prefs.getInt(_lastSyncTimeKey);
      _lastSyncTime = lastSyncTimeMs != null 
          ? DateTime.fromMillisecondsSinceEpoch(lastSyncTimeMs)
          : null;
      
      debugPrint('ğŸ“± Local state loaded: first launch=$_isFirstLaunch, onboarding=$_hasCompletedOnboarding, registered=$_isUserRegistered');
    } catch (e, stack) {
      debugPrint('âŒ Error loading local state: $e');
      await CrashlyticsService.recordError(e, stack, reason: 'Load local state failed');
    }
  }
  
  /// ä¿å­˜æœ¬åœ°ç‹€æ…‹
  Future<void> _saveLocalState() async {
    try {
      final prefs = await SharedPreferences.getInstance();
      
      await prefs.setBool(_isFirstLaunchKey, _isFirstLaunch);
      await prefs.setBool(_hasCompletedOnboardingKey, _hasCompletedOnboarding);
      await prefs.setBool(_userRegisteredKey, _isUserRegistered);
      
      if (_lastSyncTime != null) {
        await prefs.setInt(_lastSyncTimeKey, _lastSyncTime!.millisecondsSinceEpoch);
      }
      
    } catch (e, stack) {
      debugPrint('âŒ Error saving local state: $e');
      await CrashlyticsService.recordError(e, stack, reason: 'Save local state failed');
    }
  }
  
  /// åŒæ­¥ç”¨æˆ¶è³‡æ–™
  Future<void> _syncUserData() async {
    try {
      final firebaseUser = _firebaseAuthService.currentUser;
      if (firebaseUser == null) return;
      
      // æ¨™è¨˜åŒæ­¥æ™‚é–“
      _lastSyncTime = DateTime.now();
      await _saveLocalState();
      
      debugPrint('ğŸ”„ User data synced');
    } catch (e, stack) {
      debugPrint('âŒ Error syncing user data: $e');
      await CrashlyticsService.recordError(e, stack, reason: 'User data sync failed');
    }
  }
  
  /// å‰µå»º Firestore ç”¨æˆ¶è³‡æ–™
  Future<void> _createFirestoreUser(User firebaseUser) async {
    try {
      debugPrint('ğŸ‘¤ Creating Firestore user for: ${firebaseUser.uid}');
      
      await _firestoreUserService.createUser(
        uid: firebaseUser.uid,
        email: firebaseUser.email,
        nickname: firebaseUser.displayName,
        profilePhotoUrl: firebaseUser.photoURL,
        preferences: UserPreferences().toMap(),
      );
      
      debugPrint('âœ… Firestore user created successfully');
    } catch (e, stack) {
      debugPrint('âŒ Error creating Firestore user: $e');
      await CrashlyticsService.recordError(e, stack, reason: 'Firestore user creation failed');
    }
  }
  
  /// åŒæ­¥ç¤¾äº¤å¸³æˆ¶è³‡è¨Š
  Future<void> _syncSocialAccounts() async {
    try {
      final linkedAccounts = _socialAuthService.linkedAccounts;
      final socialAccountsMap = <String, dynamic>{};
      
      for (final account in linkedAccounts) {
        final accountInfo = SocialAccountInfo(
          provider: account.provider.name,
          providerId: account.providerId,
          email: account.email,
          displayName: account.displayName,
          photoUrl: account.photoUrl,
          linkedAt: account.linkedAt,
        );
        socialAccountsMap[account.provider.name] = accountInfo.toMap();
      }
      
      if (socialAccountsMap.isNotEmpty) {
        await _firestoreUserService.updateUser(socialAccounts: socialAccountsMap);
      }
      
    } catch (e, stack) {
      debugPrint('âŒ Error syncing social accounts: $e');
      await CrashlyticsService.recordError(e, stack, reason: 'Social accounts sync failed');
    }
  }
  
  /// æ¨™è¨˜é¦–æ¬¡å•Ÿå‹•å®Œæˆ
  Future<void> markFirstLaunchComplete() async {
    _isFirstLaunch = false;
    await _saveLocalState();
    notifyListeners();
    debugPrint('âœ… First launch marked as complete');
  }
  
  /// æ¨™è¨˜å¼•å°å®Œæˆ
  Future<void> markOnboardingComplete() async {
    _hasCompletedOnboarding = true;
    await _saveLocalState();
    notifyListeners();
    debugPrint('âœ… Onboarding marked as complete');
  }
  
  /// è¨»å†Šç”¨æˆ¶
  Future<void> registerUser({
    required String nickname,
    required String gender,
    required DateTime birthDate,
    required double height,
    required double weight,
    String? profilePhotoUrl,
  }) async {
    try {
      debugPrint('ğŸ“ Registering user...');
      
      await _firestoreUserService.updateUser(
        nickname: nickname,
        gender: gender,
        birthDate: birthDate,
        height: height,
        weight: weight,
        profilePhotoUrl: profilePhotoUrl,
      );
      
      _isUserRegistered = true;
      await _saveLocalState();
      
      notifyListeners();
      
      debugPrint('âœ… User registered successfully');
      await CrashlyticsService.recordUserAction('user_registered');
      
    } catch (e, stack) {
      debugPrint('âŒ Error registering user: $e');
      await CrashlyticsService.recordError(e, stack, reason: 'User registration failed');
      rethrow;
    }
  }
  
  /// æ›´æ–°ç”¨æˆ¶è³‡æ–™
  Future<void> updateUserProfile({
    String? nickname,
    String? gender,
    DateTime? birthDate,
    double? height,
    double? weight,
    String? profilePhotoUrl,
  }) async {
    try {
      await _firestoreUserService.updateUser(
        nickname: nickname,
        gender: gender,
        birthDate: birthDate,
        height: height,
        weight: weight,
        profilePhotoUrl: profilePhotoUrl,
      );
      
      debugPrint('âœ… User profile updated');
      await CrashlyticsService.recordUserAction('user_profile_updated');
      
    } catch (e, stack) {
      debugPrint('âŒ Error updating user profile: $e');
      await CrashlyticsService.recordError(e, stack, reason: 'User profile update failed');
      rethrow;
    }
  }
  
  /// æ›´æ–°ç”¨æˆ¶åå¥½è¨­å®š
  Future<void> updateUserPreferences(UserPreferences preferences) async {
    try {
      await _firestoreUserService.updatePreferences(preferences);
      
      debugPrint('âœ… User preferences updated');
      await CrashlyticsService.recordUserAction('user_preferences_updated');
      
    } catch (e, stack) {
      debugPrint('âŒ Error updating user preferences: $e');
      await CrashlyticsService.recordError(e, stack, reason: 'User preferences update failed');
      rethrow;
    }
  }
  
  /// ç™»å‡ºç”¨æˆ¶
  Future<void> logoutUser() async {
    try {
      debugPrint('ğŸ”“ Logging out user...');
      
      // 1. Firebase Auth ç™»å‡º
      await _firebaseAuthService.signOut();
      
      // 2. Social Auth æ¸…ç†
      await _socialAuthService.clearAllAccounts();
      
      // 3. æ¸…ç†æœ¬åœ°ç‹€æ…‹ï¼ˆä¿ç•™é¦–æ¬¡å•Ÿå‹•å’Œå¼•å°ç‹€æ…‹ï¼‰
      _isUserRegistered = false;
      _currentUser = null;
      _lastSyncTime = null;
      
      await _saveLocalState();
      notifyListeners();
      
      debugPrint('âœ… User logged out successfully');
      await CrashlyticsService.recordUserAction('user_logged_out');
      
    } catch (e, stack) {
      debugPrint('âŒ Error logging out user: $e');
      await CrashlyticsService.recordError(e, stack, reason: 'User logout failed');
    }
  }
  
  /// åˆªé™¤ç”¨æˆ¶å¸³æˆ¶å’Œæ‰€æœ‰è³‡æ–™
  Future<void> deleteUserAccount() async {
    try {
      debugPrint('ğŸ—‘ï¸ Deleting user account...');
      
      final uid = _firebaseAuthService.uid;
      if (uid == null) throw Exception('No authenticated user');
      
      // 1. åˆªé™¤ Firestore ç”¨æˆ¶è³‡æ–™
      await _firestoreUserService.deleteUser(uid);
      
      // 2. åˆªé™¤ Firebase Auth å¸³æˆ¶
      await _firebaseAuthService.deleteAccount();
      
      // 3. æ¸…ç†æ‰€æœ‰æœ¬åœ°è³‡æ–™
      await _resetAllData();
      
      debugPrint('âœ… User account deleted successfully');
      await CrashlyticsService.recordUserAction('user_account_deleted');
      
    } catch (e, stack) {
      debugPrint('âŒ Error deleting user account: $e');
      await CrashlyticsService.recordError(e, stack, reason: 'User account deletion failed');
      rethrow;
    }
  }
  
  /// é‡ç½®æ‰€æœ‰è³‡æ–™ï¼ˆæ¸¬è©¦ç”¨ï¼‰
  Future<void> _resetAllData() async {
    try {
      final prefs = await SharedPreferences.getInstance();
      await prefs.clear();
      
      _isFirstLaunch = true;
      _hasCompletedOnboarding = false;
      _isUserRegistered = false;
      _currentUser = null;
      _lastSyncTime = null;
      
      await _socialAuthService.clearAllAccounts();
      
      notifyListeners();
      
      debugPrint('ğŸ”„ All data reset');
    } catch (e, stack) {
      debugPrint('âŒ Error resetting data: $e');
      await CrashlyticsService.recordError(e, stack, reason: 'Reset data failed');
    }
  }
  
  /// å¼·åˆ¶åŒæ­¥ç”¨æˆ¶è³‡æ–™
  Future<void> forceSync() async {
    try {
      await _firestoreUserService.forcSync();
      await _syncUserData();
      debugPrint('âœ… Force sync completed');
    } catch (e, stack) {
      debugPrint('âŒ Error in force sync: $e');
      await CrashlyticsService.recordError(e, stack, reason: 'Force sync failed');
    }
  }
  
  /// ç²å–ç”¨æˆ¶çµ±è¨ˆè³‡è¨Š
  Map<String, dynamic> getUserStats() {
    final firestoreStats = _firestoreUserService.getUserStats();
    final socialStats = {
      'linkedSocialAccounts': _socialAuthService.linkedAccounts.length,
      'hasGoogleAccount': _socialAuthService.hasGoogleAccount,
      'hasAppleAccount': _socialAuthService.hasAppleAccount,
    };
    
    return {
      ...firestoreStats,
      ...socialStats,
      'isFirstLaunch': _isFirstLaunch,
      'hasCompletedOnboarding': _hasCompletedOnboarding,
      'isUserRegistered': _isUserRegistered,
      'lastSyncTime': _lastSyncTime?.toIso8601String(),
    };
  }
  
  /// æ¸…ç†è³‡æº
  @override
  void dispose() {
    _firebaseAuthService.removeListener(_onFirebaseAuthChanged);
    _firestoreUserService.removeListener(_onFirestoreUserChanged);
    _socialAuthService.removeListener(_onSocialAuthChanged);
    super.dispose();
  }
}